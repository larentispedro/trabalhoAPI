<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Meu Trabalho de Previsão do Tempo</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <main class="container my-5">
        
        <h1 class="text-center">Busca de Clima</h1>
        <div class="row justify-content-center mt-4">
            <div class="col-md-8 d-flex">
                <input type="text" id="campo-cidade" class="form-control me-2" placeholder="Digite uma cidade. Ex: Chapecó">
                <button id="btn-buscar" class="btn btn-primary">Buscar</button>
            </div>
        </div>

        <div id="clima-atual" class="mt-4"></div>

        <div id="previsao-container" class="mt-4"></div>

    </main>

    <footer class="text-center my-4 text-muted">
        <p>Pedro Augusto Larentis Maldaner | Disciplina: Fundamentos ao Desenvolvimento Web</p>
    </footer>

    <script>
        // Chave da API. É a sua 'senha' para poder fazer os pedidos.
        const apiKey = "dbe8956775028d1a39be909dc47347a4";

        // 'Ligando' o nosso código JavaScript aos elementos do HTML lá de cima.
        const campoCidade = document.getElementById('campo-cidade');
        const btnBuscar = document.getElementById('btn-buscar');
        const climaAtualContainer = document.getElementById('clima-atual');
        const previsaoContainer = document.getElementById('previsao-container');

        // Esta função diz: "Quando o botão 'btn-buscar' for clicado, execute o que está aqui dentro".
        btnBuscar.addEventListener('click', () => {
            const cidade = campoCidade.value; // Pega o texto que o usuário digitou.
            if (cidade) {
                buscarDadosDoClima(cidade); // Se o usuário digitou algo, chama a função principal.
            } else {
                alert("Por favor, digite o nome de uma cidade.");
            }
        });

        // --- A FUNÇÃO MAIS IMPORTANTE ---
        // async: diz que esta função vai fazer coisas que podem demorar (pedidos na internet).
        async function buscarDadosDoClima(cidade) {
            // Mostra uma mensagem de "Carregando..." para o usuário saber que algo está acontecendo.
            climaAtualContainer.innerHTML = '<p class="text-center">Buscando dados...</p>';
            previsaoContainer.innerHTML = ''; // Limpa a previsão anterior

            try {
                // --- MÉTODO 1: GEOLOCALIZAÇÃO ---
                // Pega o nome da cidade e pede para a API as coordenadas (latitude e longitude).
                // await: diz ao código para 'esperar' a resposta da API antes de continuar.
                const geoResponse = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${cidade}&limit=1&appid=${apiKey}`);
                const geoData = await geoResponse.json(); // Transforma a resposta em um objeto JavaScript.

                // Se a API não achar a cidade, geoData será uma lista vazia.
                if (geoData.length === 0) {
                    alert("Cidade não encontrada.");
                    climaAtualContainer.innerHTML = ''; // Limpa o "Carregando..."
                    return; // Para a execução da função.
                }

                // Pega a latitude e longitude da resposta.
                const lat = geoData[0].lat;
                const lon = geoData[0].lon;

                // --- MÉTODO 2: CLIMA ATUAL (DADOS SEM REPETIÇÃO) ---
                // Agora, com as coordenadas, pedimos o clima de AGORA.
                // Note os filtros: &units=metric (Celsius) e &lang=pt_br (português).
                const climaAtualResponse = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=pt_br`);
                const climaAtualData = await climaAtualResponse.json();
                
                // Chama a função que vai 'desenhar' o card do clima atual na tela.
                exibirClimaAtual(climaAtualData);

                // --- MÉTODO 3: PREVISÃO 5 DIAS (DADOS COM REPETIÇÃO) ---
                // Com as mesmas coordenadas, pedimos a previsão dos próximos dias.
                const previsaoResponse = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=pt_br`);
                const previsaoData = await previsaoResponse.json();

                // Chama a função que vai 'desenhar' os vários cards da previsão.
                // previsaoData.list é a LISTA de previsões que a API nos deu.
                exibirPrevisao(previsaoData.list);

            } catch (error) {
                // Se der qualquer erro no processo (internet caiu, API fora do ar), mostra um alerta.
                console.error("Erro:", error);
                alert("Ocorreu um erro ao buscar os dados. Tente novamente.");
            }
        }

        // Esta função só tem uma responsabilidade: criar o HTML para o card do CLIMA ATUAL.
        function exibirClimaAtual(data) {
            climaAtualContainer.innerHTML = `
                <div class="card shadow-sm">
                    <div class="card-header text-center">Clima Atual em ${data.name}</div>
                    <div class="card-body text-center">
                        <img src="https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png">
                        <h5 class="card-title">${data.main.temp.toFixed(1)}°C</h5>
                        <p class="card-text text-capitalize">${data.weather[0].description}</p>
                    </div>
                </div>
            `;
        }

        // Esta função cria o HTML para os cards da PREVISÃO.
        function exibirPrevisao(listaDePrevisoes) {
            // Filtra a lista para pegar apenas um resultado por dia (o do meio-dia).
            const previsoesFiltradas = listaDePrevisoes.filter(item => item.dt_txt.includes("12:00:00"));

            let htmlTemporario = '<h3 class="text-center mt-4">Previsão</h3>';
            htmlTemporario += '<div class="row">';

            // forEach: é um laço de repetição. Para cada item na lista de previsões, ele cria um card.
            previsoesFiltradas.forEach(previsao => {
                const data = new Date(previsao.dt * 1000);
                const dia = data.toLocaleDateString('pt-BR', { weekday: 'short' });

                htmlTemporario += `
                    <div class="col">
                        <div class="card text-center mb-3">
                            <div class="card-header">${dia}</div>
                            <div class="card-body">
                                <img src="https://openweathermap.org/img/wn/${previsao.weather[0].icon}.png">
                                <p>${previsao.main.temp.toFixed(1)}°C</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            htmlTemporario += '</div>';
            previsaoContainer.innerHTML = htmlTemporario; // Coloca todo o HTML criado na div vazia.
        }

    </script>

</body>
</html>